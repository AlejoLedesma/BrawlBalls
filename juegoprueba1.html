<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Batalla Campal - Battle Royale</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@500;700&display=swap');

        :root {
            --primary: #fbbf24; /* Amber */
            --primary-glow: rgba(251, 191, 36, 0.5);
            --danger: #ef4444;
            --success: #10b981;
            --blue: #3b82f6;
            --dark-bg: #0f172a;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --glass-bg: rgba(30, 41, 59, 0.75);
            --border: rgba(255, 255, 255, 0.15);
        }

        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Rajdhani', sans-serif; user-select: none; color: white; }
        canvas { display: block; cursor: crosshair; }
        
        #bg-particles {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.4;
            background-image: radial-gradient(circle, var(--primary) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: moveGrid 40s linear infinite;
        }
        @keyframes moveGrid { from { background-position: 0 0; } to { background-position: 60px 60px; } }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #hud { display: none; width: 100%; height: 100%; }

        /* --- BOTONES PRO --- */
        .btn {
            padding: 16px 0; font-size: 24px; 
            background: linear-gradient(135deg, var(--primary) 0%, #d97706 100%);
            color: #1a1a1a; border: none; border-radius: 8px; 
            cursor: pointer; font-family: 'Black Ops One', cursive; 
            text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 6px 0 #b45309, 0 12px 24px rgba(0, 0, 0, 0.4);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto; position: relative; overflow: hidden;
            width: 100%; text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }
        .btn:hover { transform: translateY(-4px); box-shadow: 0 10px 0 #b45309, 0 20px 40px rgba(251, 191, 36, 0.4); }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }

        .btn-small {
            padding: 12px 24px; font-size: 16px; font-weight: bold;
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%); 
            color: #e5e7eb; border: 1px solid var(--border); border-radius: 8px;
            backdrop-filter: blur(10px); cursor: pointer; pointer-events: auto;
            transition: all 0.2s; box-shadow: 0 4px 0 #1f2937;
            text-transform: uppercase; letter-spacing: 1px;
            font-family: 'Black Ops One', cursive;
        }
        .btn-small:hover { 
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            border-color: var(--primary); color: var(--primary); transform: translateY(-2px); 
            box-shadow: 0 6px 0 #1f2937, 0 0 15px rgba(251, 191, 36, 0.2);
        }
        .btn-small:active { transform: translateY(2px); box-shadow: 0 2px 0 #1f2937; }

        .btn-menu {
            padding: 15px 30px; font-size: 20px; background: #374151; color: white;
            border: none; border-radius: 8px; cursor: pointer; font-family: 'Black Ops One';
            pointer-events: auto; width: 100%; max-width: 200px;
            box-shadow: 0 4px 0 #1f2937; transition: all 0.2s;
        }
        .btn-menu:hover { background: #4b5563; transform: translateY(-2px); box-shadow: 0 6px 0 #1f2937; }
        .btn-gameover { font-size: 18px; padding: 12px 25px; }

        /* --- PANTALLAS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 100; text-align: center; display: none;
        }

        #start-screen { 
            display: flex; 
            background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 1) 100%);
        }
        
        #game-over-screen { 
            background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); 
            z-index: 200; animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { 
            font-family: 'Black Ops One', cursive; font-size: 90px; margin: 0 0 30px 0; 
            background: linear-gradient(to bottom, #fbbf24, #b45309);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 10px rgba(245, 158, 11, 0.3));
            letter-spacing: 4px; text-transform: uppercase;
            animation: floatText 3s ease-in-out infinite;
        }
        @keyframes floatText { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- HUD MEJORADO --- */
        .stat-box {
            position: absolute; background: var(--glass-bg); 
            border: 2px solid rgba(251, 191, 36, 0.3); backdrop-filter: blur(15px);
            color: white; padding: 10px 20px; border-radius: 12px; font-weight: bold; 
            pointer-events: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            font-family: 'Black Ops One'; letter-spacing: 1px; font-size: 18px;
            transition: all 0.3s;
        }
        .stat-box:hover { transform: scale(1.05); border-color: var(--primary); }

        #top-stats { top: 180px; right: 20px; text-align: right; }
        
        #zone-timer { 
            top: 20px; left: 50%; transform: translateX(-50%); 
            font-size: 28px; min-width: 140px; text-align: center;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(185, 28, 28, 0.9));
            border: none; box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulseTimer 2s infinite;
        }
        @keyframes pulseTimer { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
        
        #kills-counter { 
            top: 20px; left: 30px; display: flex; align-items: center; gap: 10px; font-size: 22px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.9), rgba(217, 119, 6, 0.9));
            color: #000; text-shadow: none; border: none;
        }

        #health-bar-container {
            position: absolute; bottom: 30px; left: 30px; width: 320px;
            display: flex; flex-direction: column; gap: 8px;
            background: var(--glass-bg); padding: 20px; border-radius: 16px;
            backdrop-filter: blur(20px); border: 2px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); transition: bottom 0.3s;
        }
        .bar-label { font-size: 12px; color: #cbd5e1; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .bar-wrapper { width: 100%; height: 12px; background: rgba(15, 23, 42, 0.8); border-radius: 6px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .bar-fill { height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .bar-fill::after { 
            content: ''; position: absolute; top:0; left:0; right:0; bottom:50%; 
            background: rgba(255,255,255,0.2); 
        }
        #hp-fill { background: linear-gradient(90deg, #ef4444, #b91c1c); box-shadow: 0 0 15px rgba(239,68,68,0.4); }
        #shield-fill { background: linear-gradient(90deg, #3b82f6, #1d4ed8); box-shadow: 0 0 15px rgba(59,130,246,0.4); }
        #stamina-wrapper { height: 6px; margin-top: 4px; border: none; }
        #stamina-fill { background: linear-gradient(90deg, #eab308, #a16207); }

        #weapon-container {
            position: absolute; bottom: 30px; right: 30px;
            background: var(--glass-bg); padding: 15px 25px;
            border-radius: 16px; border: 2px solid var(--border);
            backdrop-filter: blur(20px); font-family: 'Black Ops One'; 
            text-align: right; pointer-events: auto; min-width: 220px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); transition: bottom 0.3s;
        }
        #weapon-label { font-size: 11px; color: #94a3b8; font-family: 'Rajdhani'; font-weight: 700; letter-spacing: 2px; display: block; margin-bottom: 5px; }
        #weapon-name { font-size: 26px; color: #fff; display: block; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #ammo-display { font-size: 42px; color: var(--primary); display: flex; align-items: baseline; justify-content: flex-end; gap: 5px; line-height: 1; margin-top: 5px; text-shadow: 0 0 15px var(--primary-glow); }
        #reserve-ammo { font-size: 20px; color: #64748b; font-family: 'Rajdhani'; font-weight: bold; }
        
        #weapon-slots { display: flex; gap: 8px; justify-content: flex-end; margin-bottom: 12px; }
        .slot { 
            width: 30px; height: 30px; border-radius: 6px; 
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: #64748b; transition: all 0.3s;
        }
        .slot.active { 
            background: var(--primary); color: #1a1a1a; border-color: white; 
            transform: translateY(-4px); box-shadow: 0 5px 15px var(--primary-glow); 
        }

        /* KILL FEED */
        #kill-feed { position: absolute; top: 100px; left: 30px; width: 350px; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; pointer-events: none; }
        .kill-msg { 
            background: rgba(15, 23, 42, 0.9); color: white; padding: 10px 18px;
            border-radius: 8px; font-size: 14px; font-weight: bold;
            animation: slideInLeft 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.5s 4s forwards; 
            border-left: 4px solid var(--primary); backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); margin-bottom: 5px;
            display: flex; align-items: center; gap: 8px;
        }
        .kill-msg span.killer { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); } 
        .kill-msg span.victim { color: var(--danger); }
        @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(-20px); } }

        /* Streak Overlay */
        #streak-overlay {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Black Ops One'; font-size: 80px; color: var(--danger);
            text-shadow: 4px 4px 0 #000, 0 0 30px rgba(239, 68, 68, 0.6); 
            pointer-events: none; z-index: 150; display: none; 
            animation: popStreak 2.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popStreak { 
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; } 
            20% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; } 
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } 
        }

        /* Start Screen */
        #start-container { 
            display: flex; flex-direction: column; align-items: center; gap: 25px; 
            background: var(--panel-bg); padding: 50px 60px; border-radius: 24px; 
            border: 1px solid var(--border); box-shadow: 0 20px 80px rgba(0,0,0,0.8);
            backdrop-filter: blur(30px); position: relative;
        }
        #username-input {
            padding: 16px; font-size: 22px; border-radius: 12px;
            border: 2px solid #475569; background: rgba(15, 23, 42, 0.6); color: white;
            font-family: 'Black Ops One'; text-align: center; width: 300px;
            outline: none; text-transform: uppercase; letter-spacing: 3px; transition: all 0.3s;
        }
        #username-input:focus { border-color: var(--primary); box-shadow: 0 0 25px var(--primary-glow); transform: scale(1.02); }
        
        .controls-hint { 
            margin-top: 40px; color: #94a3b8; text-align: center; font-size: 14px; 
            background: rgba(0,0,0,0.5); padding: 15px 30px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.05); letter-spacing: 1px;
        }
        .key { 
            background: linear-gradient(180deg, #475569, #334155); padding: 5px 12px; 
            border-radius: 6px; color: white; font-weight: bold; 
            border-bottom: 3px solid #1e293b; margin: 0 5px; 
            font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-family: monospace;
        }

        /* BOTONES DE ESQUINA (LOGIN Y AMIGOS) */
        .corner-btn {
            position: absolute; top: 30px; 
            background: rgba(255,255,255,0.05); color: white; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; font-size: 14px; cursor: pointer; 
            display: flex; align-items: center; gap: 12px; border: 1px solid var(--border);
            backdrop-filter: blur(10px); transition: all 0.3s; z-index: 120;
        }
        .corner-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        #login-btn { right: 30px; }
        .logged-in { background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; color: #10b981 !important; }
        
        #friends-btn { left: 30px; border-color: var(--success); }
        #friends-btn:hover { color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }

        /* PANEL DE AMIGOS */
        #friends-panel {
            position: absolute; top: 80px; left: 30px; width: 300px;
            background: var(--panel-bg); border: 2px solid var(--success);
            border-radius: 16px; padding: 20px; display: none; flex-direction: column; gap: 15px;
            z-index: 550; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
        }
        #friends-panel.open { display: flex; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .friend-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .friend-header h3 { margin: 0; font-family: 'Black Ops One'; color: var(--success); }
        .close-friends { background: none; border: none; color: #64748b; cursor: pointer; font-size: 20px; }
        .close-friends:hover { color: var(--danger); }
        
        .friend-input-group { display: flex; gap: 5px; }
        .friend-input { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 6px; color: white; font-family: 'Rajdhani'; }
        .add-friend-btn { padding: 8px; background: var(--success); border: none; border-radius: 6px; cursor: pointer; color: black; font-weight: bold; }
        
        .friends-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; }
        .friend-status { width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-offline { background: #64748b; }
        .friend-name { font-size: 14px; font-weight: bold; color: #e2e8f0; }

        /* PANELES LATERALES */
        .side-panel {
            position: fixed; top: 0; width: 420px; height: 100%; 
            background: rgba(10, 15, 30, 0.98); padding: 50px 40px; box-sizing: border-box;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); z-index: 500;
            display: flex; flex-direction: column; align-items: stretch; gap: 25px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.9); pointer-events: auto;
            backdrop-filter: blur(20px);
        }
        #side-panel-left { left: 0; border-right: 1px solid var(--border); transform: translateX(-100%); }
        #side-panel-left.open { transform: translateX(0); }
        #side-panel-right { right: 0; border-left: 1px solid var(--border); transform: translateX(100%); }
        #side-panel-right.open { transform: translateX(0); }

        .panel-title { 
            font-family: 'Black Ops One'; color: var(--primary); font-size: 36px; 
            text-align: center; border-bottom: 2px solid #334155; padding-bottom: 20px; margin: 0;
            text-shadow: 0 0 20px var(--primary-glow); letter-spacing: 2px;
        }
        .panel-section { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .panel-label { color: #94a3b8; font-weight: bold; margin-bottom: 4px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        .panel-input { 
            width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; 
            color: white; border-radius: 8px; font-family: 'Rajdhani'; font-size: 18px; font-weight: bold;
            box-sizing: border-box; transition: 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .panel-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        
        .panel-checkbox { 
            display: flex; align-items: center; justify-content: space-between; 
            color: #cbd5e1; font-weight: bold; font-size: 15px; cursor: pointer;
            padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; transition: 0.2s;
        }
        .panel-checkbox:hover { background: rgba(255,255,255,0.06); }
        .panel-checkbox input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }

        /* Room Boxes (Dise√±o Solicitado) */
        .room-section-container { width: 100%; display: flex; flex-direction: column; gap: 20px; height: 100%; overflow: hidden; }
        .room-card {
            padding: 24px; border-radius: 12px; width: 100%; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 15px; border-left: 6px solid;
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.6)); 
            transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.05); pointer-events: auto;
            position: relative; overflow: hidden;
        }
        .room-card:hover { transform: translateX(5px); background: linear-gradient(90deg, rgba(40, 55, 80, 0.9), rgba(20, 30, 50, 0.7)); }
        .room-card h3 { margin: 0; font-family: 'Black Ops One'; color: #f1f5f9; font-size: 22px; display: flex; align-items: center; gap: 10px; }
        
        .room-card.blue { border-left-color: var(--blue); }
        .room-card.blue h3 { color: var(--blue); }
        .room-card.red { border-left-color: var(--danger); }
        .room-card.red h3 { color: var(--danger); }
        .room-card.green { border-left-color: var(--success); flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        .room-card.green h3 { color: var(--success); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; width: 100%; }

        .room-list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); padding: 15px; margin-bottom: 10px; border-radius: 8px;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .room-list-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); transform: scale(1.01); }
        .room-name { color: #e2e8f0; font-weight: 700; font-size: 16px; }
        .room-lock { font-size: 12px; color: #94a3b8; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        #room-list { overflow-y: auto; padding-right: 5px; flex-grow: 1; scrollbar-width: thin; scrollbar-color: #475569 transparent; }

        /* LOBBY */
        #lobby-screen { display: none; background: #0b1120; z-index: 150; }
        .lobby-container {
            width: 90%; max-width: 1000px; background: rgba(15, 23, 42, 0.98);
            border: 1px solid var(--border); border-radius: 24px; padding: 50px;
            display: grid; grid-template-columns: 1fr 1.5fr; gap: 50px;
            box-shadow: 0 0 100px rgba(0,0,0,0.8); backdrop-filter: blur(30px);
        }
        .lobby-code { 
            font-size: 56px; color: var(--primary); text-align: center; margin: 20px 0 40px; 
            font-family: 'Black Ops One'; text-shadow: 0 0 30px var(--primary-glow);
            border: 2px dashed #475569; padding: 20px; border-radius: 12px;
        }
        .lobby-players { height: 300px; background: rgba(0,0,0,0.4); border-radius: 12px; border: 1px solid #334155; padding: 20px; overflow-y: auto; }
        .lobby-player-row { padding: 10px; color: #e2e8f0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; }

        /* Game Over */
        #final-rank { font-size: 140px; font-family: 'Black Ops One'; margin: 0; line-height: 1; background: linear-gradient(to bottom, #fbbf24, #b45309); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.6)); }
        #stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; width: 100%; max-width: 700px; margin: 40px 0; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: left; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.08); border-color: var(--primary); }
        .stat-val { float: right; color: var(--primary); font-family: 'Black Ops One'; font-size: 24px; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        #spectator-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 90px; background: rgba(10, 15, 30, 0.95); border-top: 4px solid var(--primary); display: none; align-items: center; justify-content: space-between; padding: 0 50px; z-index: 100; pointer-events: auto; box-shadow: 0 -20px 60px rgba(0,0,0,0.8); }
        
        .close-panel-btn { position: absolute; top: 25px; background: none; border: none; color: #64748b; font-size: 32px; cursor: pointer; transition: 0.2s; z-index: 10; pointer-events: auto; }
        #side-panel-left .close-panel-btn { right: 25px; }
        #side-panel-right .close-panel-btn { left: 25px; }
        .close-panel-btn:hover { color: var(--danger); transform: scale(1.1); }
        
        .color-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; padding: 0 20px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 16px; cursor: pointer; border: 4px solid transparent; transition: all 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: white; transform: scale(1.05); box-shadow: 0 0 25px rgba(255,255,255,0.4); }

        #streak-overlay { position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); font-family: 'Black Ops One'; font-size: 80px; color: var(--danger); text-shadow: 4px 4px 0 #000, 0 0 30px rgba(239, 68, 68, 0.6); pointer-events: none; z-index: 150; display: none; animation: popStreak 2.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popStreak { 0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; } 20% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

    </style>
</head>
<body class="">

    <canvas id="gameCanvas"></canvas>
    <div id="bg-particles"></div>
    <div id="damage-overlay"></div>
    <div id="vignette"></div>
    <div id="countdown-overlay">3</div>
    <div id="streak-overlay"></div>

    <!-- BOTONES DE ESQUINA (SOLO VISIBLES EN MEN√ö) -->
    <button id="login-btn" class="corner-btn" onclick="toggleLogin()">
        <div style="width:24px;height:24px;background:conic-gradient(from -45deg, #ea4335 110deg, #4285f4 90deg 180deg, #34a853 180deg 270deg, #fbbc05 270deg) 50% 50%/100% 100% no-repeat;border-radius:50%;"></div>
        INICIAR SESI√ìN
    </button>
    
    <button id="friends-btn" class="corner-btn" onclick="toggleFriendsPanel()">
        üë• AMIGOS
    </button>

    <!-- PANEL DE AMIGOS -->
    <div id="friends-panel">
        <div class="friend-header">
            <h3>AMIGOS</h3>
            <button class="close-friends" onclick="toggleFriendsPanel()">‚úï</button>
        </div>
        <div class="friend-input-group">
            <input type="text" id="friend-input" class="friend-input" placeholder="Nombre...">
            <button class="add-friend-btn" onclick="addFriend()">+</button>
        </div>
        <div class="friends-list" id="friends-list-container">
            <!-- JS inserts -->
        </div>
    </div>

    <!-- PANELES -->
    <div id="side-panel-left" class="side-panel">
        <button class="close-panel-btn" onclick="toggleCustomizationPanel()">‚úï</button>
        <h2 class="panel-title">PERSONALIZAR</h2>
        <div style="margin-top: 40px; width: 100%; display: flex; flex-direction: column; align-items: center;">
            <span class="color-section-title" style="color: #94a3b8; font-weight: bold; margin-bottom: 20px; font-size: 16px; letter-spacing: 2px;">SELECCIONA TU ESTILO</span>
            <div id="player-colors" class="color-grid"></div>
        </div>
    </div>

    <div id="side-panel-right" class="side-panel">
        <button class="close-panel-btn" onclick="toggleCustomMatchPanel()">‚úï</button>
        <h2 class="panel-title" style="margin-bottom: 30px;">SALA PRIVADA</h2>
        <div class="room-section-container">
            <div class="room-card blue">
                <h3><span style="font-size:24px;">‚úö</span> CREAR SALA</h3>
                <button class="btn btn-small" style="width:100%; background:#3b82f6; margin-top:10px;" onclick="showLobbyScreen(true)">CONFIGURAR NUEVA</button>
            </div>
            <div class="room-card red">
                <h3><span style="font-size:24px;">‚ûú</span> UNIRSE</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top:5px;">
                    <input type="text" class="panel-input" id="join-code" placeholder="C√ìDIGO DE SALA" style="text-align:center; font-weight:900; letter-spacing:1px;">
                    <input type="password" class="panel-input" id="join-pass" placeholder="CONTRASE√ëA (OPCIONAL)" style="text-align:center;">
                    <button class="btn btn-small" style="width:100%; background:var(--danger); border-color:var(--danger);" onclick="joinRoom()">ENTRAR AHORA</button>
                </div>
            </div>
            <div class="room-card green">
                <h3><span style="font-size:24px;">‚ò∞</span> SALAS DISPONIBLES</h3>
                <div id="room-list">
                    <div class="room-list-item" onclick="document.getElementById('join-code').value='PRO123'">
                        <span class="room-name">Torneo Pro</span>
                        <span class="room-lock">üîí Privada</span>
                    </div>
                    <div class="room-list-item" onclick="document.getElementById('join-code').value='FFA01'">
                        <span class="room-name">Todos contra Todos</span>
                        <span class="room-lock" style="color:var(--success);">üîì P√∫blica</span>
                    </div>
                     <div class="room-list-item" onclick="document.getElementById('join-code').value='SNIPER'">
                        <span class="room-name">Solo Snipers</span>
                        <span class="room-lock" style="color:var(--success);">üîì P√∫blica</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="kill-feed"></div>
        <div id="spectator-bar">
            <div id="spectator-info">ESPECTANDO A: <span style="color:var(--primary);">JUGADOR</span></div>
            <div id="spectator-controls">
                <button class="btn-menu btn-gameover" onclick="location.reload()">SALIR</button>
                <button class="btn btn-gameover" onclick="restartGame()">REJUGAR</button>
            </div>
        </div>

        <div id="lobby-screen" class="screen">
            <div class="lobby-container">
                <div class="lobby-config">
                    <h2 style="font-family:'Black Ops One'; color:var(--primary); margin-bottom:30px;">CONFIGURACI√ìN</h2>
                    <div id="creator-controls">
                        <div class="panel-section">
                            <label class="panel-label">TIPO DE PARTIDA</label>
                            <select id="lobby-type" class="panel-input">
                                <option value="public">üîì P√∫blica</option>
                                <option value="private">üîí Privada</option>
                            </select>
                        </div>
                        <div class="panel-section" id="lobby-pass-section" style="display:none;">
                            <label class="panel-label">CONTRASE√ëA DE SALA</label>
                            <input type="text" id="lobby-pass" class="panel-input" placeholder="Crear contrase√±a...">
                        </div>
                        <div class="panel-section">
                            <label class="panel-label">DIFICULTAD (BOTS)</label>
                            <select id="lobby-bots" class="panel-input">
                                <option value="10">Entrenamiento (10)</option>
                                <option value="19" selected>Normal (20 Jugadores)</option>
                                <option value="50">Caos Total (50)</option>
                            </select>
                        </div>
                    </div>
                    <div id="guest-controls" style="display:none; color: #94a3b8; text-align:center; padding: 40px; background:rgba(255,255,255,0.05); border-radius:8px;">
                        <h3 style="margin:0;">ESPERANDO AL ANFITRI√ìN</h3>
                        <p>La configuraci√≥n est√° bloqueada.</p>
                    </div>
                    
                    <div style="margin-top: 50px; display: flex; gap: 15px;">
                         <button class="btn btn-small" style="background:transparent; border-color:var(--danger); color:var(--danger);" onclick="exitLobby()">CANCELAR</button>
                         <button id="start-match-btn" class="btn" style="flex:1;" onclick="startCustomMatch()">INICIAR PARTIDA</button>
                    </div>
                </div>

                <div class="lobby-info" style="border-left: 2px solid #334155; padding-left: 50px; display: flex; flex-direction: column; justify-content: center;">
                    <div style="text-align: center;">
                        <h2 style="font-size: 24px; color: #94a3b8; margin:0; letter-spacing:2px;">C√ìDIGO DE SALA</h2>
                        <div class="lobby-code" id="lobby-code-text" style="font-size: 48px; color: var(--primary); font-family: 'Black Ops One';">----</div>
                    </div>
                    <label class="panel-label" style="margin-top:30px; color:#94a3b8;">JUGADORES CONECTADOS (1/20)</label>
                    <div class="lobby-players" id="lobby-player-list" style="flex-grow:1; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-y:auto; border: 1px solid #374151;"></div>
                </div>
            </div>
        </div>

        <div id="hud">
            <div id="kills-counter" class="stat-box">üíÄ <span id="kill-count">0</span></div>
            <div id="zone-timer" class="stat-box">‚è≥ <span id="timer">00:00</span></div>
            <div id="top-stats" class="stat-box">VIVOS: <span id="alive-count" style="color:var(--primary); font-size:24px;">0</span>/<span id="total-count">0</span></div>
            <div id="health-bar-container">
                <div class="bar-label"><span>ESCUDO</span> <span id="shield-val">0</span></div>
                <div class="bar-wrapper"><div id="shield-fill" class="bar-fill"></div></div>
                <div class="bar-label" style="margin-top:8px;"><span>SALUD</span> <span id="hp-val">100</span></div>
                <div class="bar-wrapper"><div id="hp-fill" class="bar-fill"></div></div>
                <div class="bar-wrapper" id="stamina-wrapper"><div id="stamina-fill" class="bar-fill"></div></div>
            </div>
            <div id="weapon-container">
                <div id="weapon-slots">
                    <div id="slot-1" class="slot active">1</div>
                    <div id="slot-2" class="slot">2</div>
                    <div id="slot-3" class="slot">G</div>
                </div>
                <span id="weapon-label">EQUIPADO</span>
                <span id="weapon-name">Pistola</span>
                <div id="ammo-display"><span id="current-mag">30</span><span id="reserve-ammo">/ 90</span></div>
            </div>
        </div>

        <div id="start-screen" class="screen">
            <div id="start-container">
                <h1>BATALLA<br>CAMPAL</h1>
                <input type="text" id="username-input" placeholder="TU NOMBRE DE AGENTE" maxlength="12" autocomplete="off">
                <button class="btn" onclick="startGame()">DESPLEGAR AHORA</button>
                <div style="display: flex; gap: 15px; width: 100%; justify-content: center; margin-top:10px;">
                    <button class="btn btn-small" onclick="toggleCustomizationPanel()">PERSONALIZAR</button>
                    <button class="btn btn-small" onclick="toggleCustomMatchPanel()">SALA PRIVADA</button>
                </div>
            </div>
            <div class="controls-hint">
                <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> MOVERSE &nbsp;&nbsp; 
                <span class="key">SHIFT</span> CORRER &nbsp;&nbsp; 
                <span class="key">E</span> INTERACTUAR &nbsp;&nbsp;
                <span class="key">1</span><span class="key">2</span><span class="key">3</span> ARMAS
            </div>
        </div>

        <div id="game-over-screen" class="screen">
            <h1 id="end-title">FIN</h1>
            <div id="rank-container"><div id="rank-label">POSICI√ìN FINAL</div><div id="final-rank">#1</div></div>
            <div class="msg" id="end-reason" style="color: #94a3b8; font-size: 24px; margin-bottom: 40px; font-weight:bold;">Eliminado</div>
            <div id="stats-grid">
                <div class="stat-card">BAJAS <span class="stat-val" id="stat-kills">0</span></div>
                <div class="stat-card">TIEMPO <span class="stat-val" id="stat-time">0s</span></div>
                <div class="stat-card">DA√ëO <span class="stat-val" id="stat-damage">0</span></div>
                <div class="stat-card">EQUIPO <span class="stat-val" id="stat-upgrades">0</span></div>
            </div>
            <div id="game-over-buttons">
                <button class="btn-menu btn-gameover" onclick="location.reload()">MEN√ö PRINCIPAL</button>
                <button id="btn-spectate" class="btn btn-gameover" style="display:none; background:#3b82f6;" onclick="startSpectate()">MODO ESPECTADOR</button>
                <button class="btn btn-gameover" onclick="restartGame()">JUGAR DE NUEVO</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // FIREBASE CONFIG
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    let app, auth, db, userId;

    if (firebaseConfig) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        signInAnonymously(auth).then((userCredential) => {
            userId = userCredential.user.uid;
            console.log("Logged in as:", userId);
        }).catch((error) => console.error("Auth Error:", error));
    }

    // EXPOSE GLOBAL FUNCTIONS
    window.toggleLogin = toggleLogin;
    window.toggleFriendsPanel = toggleFriendsPanel;
    window.addFriend = addFriend;
    window.toggleCustomizationPanel = toggleCustomizationPanel;
    window.toggleCustomMatchPanel = toggleCustomMatchPanel;
    window.showLobbyScreen = showLobbyScreen;
    window.joinRoom = joinRoom;
    window.exitLobby = exitLobby;
    window.startCustomMatch = startCustomMatch;
    window.startGame = startGame;
    window.restartGame = restartGame;
    window.startSpectate = startSpectate;

    // --- AMIGOS (JS) ---
    let friends = [
        {name: "Bot_01", status: "online"},
        {name: "ProGamer", status: "offline"},
        {name: "JuanWick", status: "online"}
    ];

    function toggleFriendsPanel() {
        const p = document.getElementById('friends-panel');
        if(p.style.display === 'flex') p.style.display = 'none';
        else { p.style.display = 'flex'; p.classList.add('open'); renderFriends(); }
    }

    function addFriend() {
        const input = document.getElementById('friend-input');
        const name = input.value.trim();
        if(name) {
            friends.push({name: name, status: 'offline'}); 
            input.value = '';
            renderFriends();
        }
    }

    function renderFriends() {
        const list = document.getElementById('friends-list-container');
        list.innerHTML = '';
        friends.forEach(f => {
            let item = document.createElement('div');
            item.className = 'friend-item';
            item.innerHTML = `
                <div class="friend-status status-${f.status}"></div>
                <div class="friend-name">${f.name}</div>
            `;
            list.appendChild(item);
        });
    }

    // --- AUDIO SYSTEM ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let noiseBuffer = null;

    function createNoiseBuffer() {
        if (noiseBuffer) return;
        const bufferSize = audioCtx.sampleRate * 2;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        noiseBuffer = buffer;
    }

    const Sound = {
        init: () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            createNoiseBuffer();
        },
        playNoise: (duration, filterType, freqStart, freqEnd, vol) => {
            if (!noiseBuffer) createNoiseBuffer();
            const t = audioCtx.currentTime;
            const source = audioCtx.createBufferSource();
            source.buffer = noiseBuffer;
            const filter = audioCtx.createBiquadFilter(); filter.type = filterType;
            filter.frequency.setValueAtTime(freqStart, t); filter.frequency.exponentialRampToValueAtTime(freqEnd, t + duration);
            const gain = audioCtx.createGain(); gain.gain.setValueAtTime(vol, t); gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
            source.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            source.start(); source.stop(t + duration);
        },
        playTone: (freq, type, duration, vol = 0.1) => {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        },
        shoot: (type) => {
            Sound.init();
            if (type === 'knife') { Sound.playNoise(0.1, 'lowpass', 600, 100, 0.1); } 
            else if (type === 'shotgun') { Sound.playNoise(0.3, 'lowpass', 1000, 50, 0.5); Sound.playTone(60, 'square', 0.1, 0.2); }
            else if (type === 'sniper') { Sound.playNoise(0.4, 'highpass', 500, 100, 0.6); }
            else if (type === 'grenade') { Sound.playNoise(0.1, 'lowpass', 400, 100, 0.3); } 
            else { Sound.playNoise(0.1, 'lowpass', 3000, 100, 0.3); }
        },
        explode: () => { Sound.playNoise(0.8, 'lowpass', 1000, 50, 1.0); },
        hit: () => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); },
        reload: () => { Sound.playTone(600, 'square', 0.05, 0.05); setTimeout(() => Sound.playTone(800, 'square', 0.05, 0.05), 150); },
        ui: () => Sound.playTone(400, 'sine', 0.05, 0.05),
        kill: () => { Sound.playTone(400, 'sine', 0.1, 0.2); setTimeout(()=>Sound.playTone(600, 'sine', 0.2, 0.2), 100); }
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resize);
    resize();

    const keys = {};
    const mouse = { x: 0, y: 0, down: false };
    let interactableItem = null;
    let gameSettings = { time: 120, botCount: 30, lootDensity: 1, lowGravity: false, infiniteAmmo: false };
    let totalPlayersStart = 20;

    window.addEventListener('keydown', e => {
        keys[e.code] = true;
        if (e.code === 'KeyR' && player && gameState === 'PLAYING') player.reload();
        if (e.code === 'Digit1' && player && gameState === 'PLAYING') player.switchSlot(0);
        if (e.code === 'Digit2' && player && gameState === 'PLAYING') player.switchSlot(1);
        if (e.code === 'Digit3' && player && gameState === 'PLAYING') player.switchSlot(2);
        
        if (e.code === 'KeyE' && player && gameState === 'PLAYING' && interactableItem) {
            player.swapWeapon(interactableItem);
            Sound.ui();
        }

        if (e.code === 'Enter' && gameState === 'START' && 
            !document.getElementById('side-panel-left').classList.contains('open') &&
            !document.getElementById('side-panel-right').classList.contains('open') &&
            document.getElementById('lobby-screen').style.display === 'none') startGame();
    });
    window.addEventListener('keyup', e => keys[e.code] = false);
    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('mousedown', () => { mouse.down = true; if(gameState==='START') Sound.ui(); });
    window.addEventListener('mouseup', () => mouse.down = false);

    const MAP_SIZE = 2500; const TILE_SIZE = 100;
    const COLORS = { grass: '#4ade80', zone: 'rgba(220, 38, 38, 0.4)', zoneLine: 'rgba(239, 68, 68, 0.9)' };
    const PRESET_COLORS = ['#ef4444', '#facc15', '#3b82f6', '#f97316', '#22c55e', '#a855f7', '#ec4899', '#111827', '#f3f4f6'];
    let selectedPlayerColor = '#3b82f6'; 

    class Camera {
        constructor() { this.x = 0; this.y = 0; this.shakeX = 0; this.shakeY = 0; this.shakeTime = 0; }
        update(target, dt) {
            if(!target) return;
            this.x += (target.x - this.x) * 0.1; this.y += (target.y - this.y) * 0.1;
            if (this.shakeTime > 0) {
                this.shakeTime -= dt; let power = this.shakeTime * 20;
                this.shakeX = (Math.random() - 0.5) * power; this.shakeY = (Math.random() - 0.5) * power;
            } else { this.shakeX = 0; this.shakeY = 0; }
        }
        shake(amount) { this.shakeTime = amount; }
    }
    const camera = new Camera();

    function initCustomizationUI() {
        const playerGrid = document.getElementById('player-colors');
        PRESET_COLORS.forEach(color => {
            let pSwatch = document.createElement('div');
            pSwatch.className = 'color-swatch' + (color === selectedPlayerColor ? ' selected' : '');
            pSwatch.style.backgroundColor = color;
            pSwatch.onclick = () => { selectColor(color, pSwatch); Sound.ui(); };
            playerGrid.appendChild(pSwatch);
        });
    }
    function selectColor(color, element) {
        selectedPlayerColor = color;
        document.querySelectorAll('#player-colors .color-swatch').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }
    function toggleCustomizationPanel() { 
        document.getElementById('side-panel-right').classList.remove('open'); 
        document.getElementById('side-panel-left').classList.toggle('open'); Sound.ui(); 
    }
    function toggleCustomMatchPanel() {
        document.getElementById('side-panel-left').classList.remove('open'); 
        document.getElementById('side-panel-right').classList.toggle('open'); Sound.ui();
    }
    
    document.getElementById('lobby-type').addEventListener('change', (e) => {
        document.getElementById('lobby-pass-section').style.display = e.target.value === 'private' ? 'flex' : 'none';
    });

    initCustomizationUI();

    const WEAPONS = {
        knife: { name: "Cuchillo", type: 'melee', damage: 25, rate: 0.5, range: 60, color: '#9ca3af', count: 0, infiniteAmmo: true },
        grenade: { name: "Granada", type: 'throwable', damage: 80, rate: 1.0, speed: 600, radius: 150, color: '#10b981', count: 0, maxCount: 3 },
        pistol: { name: "Pistola", type: 'range', damage: 12, rate: 0.3, speed: 700, spread: 0.05, mag: 15, maxReserve: 60, reload: 1.5, color: '#facc15', count: 1 },
        rifle:  { name: "Fusil Asalto", type: 'range', damage: 18, rate: 0.12, speed: 900, spread: 0.08, mag: 30, maxReserve: 120, reload: 2.0, color: '#60a5fa', count: 1 },
        shotgun:{ name: "Escopeta", type: 'range', damage: 8, rate: 0.8, speed: 600, spread: 0.4, mag: 6, maxReserve: 30, reload: 2.5, color: '#f87171', count: 6 },
        sniper: { name: "Sniper", type: 'range', damage: 85, rate: 1.2, speed: 1500, spread: 0.01, mag: 5, maxReserve: 20, reload: 3.0, color: '#a78bfa', count: 1 }
    };

    const BOT_NAMES = ["Terminator", "NoobSlayer", "CamperPro", "JuanWick", "LagMaster", "TryHard", "Bot_404", "Ninja", "Ghost", "Viper"];
    let gameState = 'START'; let lastTime = 0; let gameTime = 0; const COUNTDOWN_TIME = 3; 
    let isLogged = false; let countdownTimer = COUNTDOWN_TIME;
    
    let player, bots = [], bullets = [], items = [], trees = [], bushes = [], rocks = [], particles = [], messages = [], damageTexts = [];
    let grenadeProjectiles = []; let bloodSplats = [];
    let hitMarkerTime = 0; let zone = { radius: MAP_SIZE, targetRadius: 0, shrinkSpeed: 15, damage: 10, nextPhaseTime: 0 };
    let spectatingTarget = null; let lastKiller = null;

    function toggleLogin() { Sound.ui(); isLogged = !isLogged; const btn = document.getElementById('login-btn'); const input = document.getElementById('username-input'); if(isLogged) { btn.innerHTML = "üë§ Usuario"; btn.classList.add('logged-in'); input.value = "PRO"; } else { btn.innerHTML = "Iniciar Sesi√≥n"; btn.classList.remove('logged-in'); input.value = ""; } }
    function addKillFeed(killer, victim) {
        const feed = document.getElementById('kill-feed'); const msg = document.createElement('div'); msg.className = 'kill-msg';
        msg.innerHTML = `<span class="killer">${killer}</span> üî´ <span class="victim">${victim}</span>`; feed.appendChild(msg);
        if(feed.children.length > 5) feed.removeChild(feed.firstChild); setTimeout(() => { if(msg.parentNode) msg.parentNode.removeChild(msg); }, 4000);
    }
    
    function showStreakMessage(msg) {
        const ov = document.getElementById('streak-overlay');
        ov.innerText = msg; ov.style.display = 'block';
        setTimeout(() => { ov.style.display = 'none'; }, 2000);
    }

    class Entity { constructor(x, y, radius, color) { this.x = x; this.y = y; this.radius = radius; this.color = color; this.markedForDeletion = false; } }

    class BloodSplat {
        constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.radius = 10 + Math.random() * 20; this.life = 60; }
    }

    class GrenadeProjectile extends Entity {
        constructor(x, y, angle, speed, owner) {
            super(x, y, 6, '#10b981');
            this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
            this.owner = owner; this.timer = 1.5; this.friction = 0.95;
        }
        update(dt) {
            this.x += this.vx * dt; this.y += this.vy * dt;
            this.vx *= this.friction; this.vy *= this.friction; this.timer -= dt;
             rocks.forEach(r => { if(dist(this.x, this.y, r.x, r.y) < this.radius + r.radius) { this.vx *= -0.8; this.vy *= -0.8; } });
            if(this.timer <= 0) { this.explode(); this.markedForDeletion = true; }
        }
        explode() {
            Sound.explode(); createParticles(this.x, this.y, '#f59e0b', 20); createParticles(this.x, this.y, '#78350f', 10);
            let targets = [player, ...bots];
            targets.forEach(t => {
                if(t.markedForDeletion) return;
                let d = dist(this.x, this.y, t.x, t.y);
                if(d < WEAPONS.grenade.radius) { let dmg = WEAPONS.grenade.damage * (1 - d/WEAPONS.grenade.radius); t.takeDamage(dmg, this.owner); }
            });
            trees.forEach(t => { if(dist(this.x, this.y, t.x, t.y) < WEAPONS.grenade.radius) { t.hp = 0; t.markedForDeletion = true; createParticles(t.x, t.y, '#166534', 15); } });
        }
    }

    class Character extends Entity {
        constructor(x, y, isPlayer = false, customColor = null) {
            super(x, y, 20, (isPlayer && customColor) ? customColor : (isPlayer ? selectedPlayerColor : '#ef4444'));
            this.isPlayer = isPlayer; this.hp = 100; this.maxHp = 100; this.shield = isPlayer ? 0 : 50; this.maxShield = 100;
            this.stamina = 100; this.maxStamina = 100;
            this.speed = 250; this.angle = 0; this.velocity = { x: 0, y: 0 }; this.z = 0; this.vz = 0; this.isJumping = false;
            this.kills = 0; this.name = isPlayer ? "JUGADOR" : BOT_NAMES[Math.floor(Math.random()*BOT_NAMES.length)];
            this.stats = { damageDealt: 0, upgrades: 0 }; this.attackTimer = 0;
            
            // INVENTARIO: 0: Arma, 1: Cuchillo, 2: Granadas
            this.inventory = [
                null, 
                { ...WEAPONS.knife, cooldown: 0 },
                null
            ];
            
            this.activeSlot = 1; // Empezar con Cuchillo

            if(!isPlayer) { this.pickUpWeapon(['pistol', 'rifle', 'shotgun'][Math.floor(Math.random()*3)]); }
            if (!isPlayer) { this.state = 'WANDER'; this.reactionTimer = 0; this.strafeTimer = 0; this.strafeDir = 1; }
        }
        get weapon() { return this.inventory[this.activeSlot]; }
        
        pickUpWeapon(type) {
            const w = WEAPONS[type];
            this.inventory[0] = { type: type, ...w, cooldown: 0, currentMag: w.mag, magSize: w.mag, reserveAmmo: w.mag * 3, maxReserve: w.maxReserve, reloadTimer: 0, isReloading: false };
            this.switchSlot(0); // Cambiar a arma nueva
        }
        
        pickUpGrenade() {
            const w = WEAPONS.grenade;
            if(!this.inventory[2]) { 
                this.inventory[2] = { type: 'grenade', ...w, cooldown: 0, count: 3 }; 
                if(this.isPlayer) showFloatingMessage("+3 GRANADAS", this.x, this.y, '#10b981');
            } else { 
                this.inventory[2].count = 3; 
                if(this.isPlayer) showFloatingMessage("GRANADAS LLENAS", this.x, this.y, '#10b981');
            }
        }

        // NUEVA FUNCION: Intercambiar arma del suelo
        swapWeapon(groundItem) {
            if (groundItem.type === 'medkit' || groundItem.type === 'shield' || groundItem.type === 'ammo' || groundItem.type === 'grenade') return;

            // Soltar arma actual si existe
            if (this.inventory[0]) {
                let oldWep = this.inventory[0];
                // Crear item en el suelo con el tipo de arma antigua
                items.push(new Item(this.x, this.y, oldWep.type)); 
            }

            this.pickUpWeapon(groundItem.type);
            
            groundItem.markedForDeletion = true;
            interactableItem = null;
        }

        switchSlot(index) {
            if (index === 0 && !this.inventory[0]) return; 
            if (index === 1 && !this.inventory[1]) return; 
            if (index === 2 && (!this.inventory[2] || this.inventory[2].count <= 0)) return; 
            
            this.activeSlot = index;
            if(this.weapon && this.weapon.isReloading) { this.weapon.isReloading = false; this.weapon.reloadTimer = 0; }
            if(this.isPlayer || gameState === 'SPECTATING') updateHUD();
        }

        update(dt) {
            if (gameState === 'COUNTDOWN') { this.velocity = { x: 0, y: 0 }; return; }

            // SPRINT LOGIC
            let currentSpeed = this.speed;
            if (this.isPlayer && keys['ShiftLeft'] && this.stamina > 0 && (this.velocity.x !== 0 || this.velocity.y !== 0)) {
                currentSpeed *= 1.5;
                this.stamina -= 20 * dt;
                if(this.stamina < 0) this.stamina = 0;
            } else {
                this.stamina += 10 * dt;
                if(this.stamina > this.maxStamina) this.stamina = this.maxStamina;
            }

            // GRAVEDAD MODIFICADA SI APLICA
            let gravity = gameSettings.lowGravity ? 300 : 900;

            this.x += this.velocity.x * (currentSpeed / this.speed) * dt;
            this.y += this.velocity.y * (currentSpeed / this.speed) * dt;
            this.x = Math.max(0, Math.min(MAP_SIZE, this.x)); this.y = Math.max(0, Math.min(MAP_SIZE, this.y));
            if (this.z > 0 || this.vz > 0) { this.z += this.vz * dt; this.vz -= gravity * dt; if (this.z <= 0) { this.z = 0; this.vz = 0; this.isJumping = false; } }
            if (this.attackTimer > 0) this.attackTimer -= dt;
            
            if (this.weapon && this.weapon.cooldown > 0) this.weapon.cooldown -= dt;
            
            if (this.weapon && this.weapon.type !== 'melee' && this.weapon.type !== 'throwable' && this.weapon.isReloading) {
                this.weapon.reloadTimer -= dt;
                if (this.weapon.reloadTimer <= 0) {
                    this.weapon.isReloading = false;
                    let needed = this.weapon.magSize - this.weapon.currentMag;
                    let toLoad = Math.min(needed, this.weapon.reserveAmmo);
                    this.weapon.currentMag += toLoad; this.weapon.reserveAmmo -= toLoad;
                    if(this.isPlayer) updateHUD();
                }
            }
            rocks.forEach(r => {
                 if(dist(this.x, this.y, r.x, r.y) < this.radius + r.radius) {
                     let ang = Math.atan2(this.y - r.y, this.x - r.x);
                     let push = (this.radius + r.radius) - dist(this.x, this.y, r.x, r.y);
                     this.x += Math.cos(ang) * push; this.y += Math.sin(ang) * push;
                 }
            });
            const distToCenter = Math.hypot(this.x - MAP_SIZE/2, this.y - MAP_SIZE/2);
            if (distToCenter > zone.radius) this.takeDamage(zone.damage * dt, null, true);
            if (!this.isPlayer) this.updateAI(dt);
        }
        reload() {
            if (gameState === 'COUNTDOWN') return;
            if (!this.weapon) return;
            if (this.weapon.type === 'melee' || this.weapon.type === 'throwable') return; 
            
            // INFINITE AMMO FOR BOTS FIX
            let reserve = this.isPlayer ? this.weapon.reserveAmmo : 9999;

            if (!this.weapon.isReloading && this.weapon.currentMag < this.weapon.magSize && reserve > 0) {
                this.weapon.isReloading = true; this.weapon.reloadTimer = this.weapon.reload; if(this.isPlayer || gameState === 'SPECTATING') { updateHUD(); Sound.reload(); }
            }
        }
        updateAI(dt) {
            if (gameState === 'COUNTDOWN') return;
            this.reactionTimer -= dt;
            
            // STRAFE LOGIC
            if (this.strafeTimer > 0) this.strafeTimer -= dt;
            else {
                this.strafeTimer = 1 + Math.random();
                this.strafeDir = Math.random() > 0.5 ? 1 : -1;
            }

            let enemies = [player, ...bots].filter(e => e !== this && !e.markedForDeletion);
            let nearest = null, minDst = 700;
            enemies.forEach(e => {
                let inBush = false; for(let b of bushes) if(dist(e.x, e.y, b.x, b.y) < b.radius) { inBush = true; break; }
                let visRange = inBush ? 150 : 700; let d = dist(this.x, this.y, e.x, e.y);
                if (d < minDst && d < visRange) { minDst = d; nearest = e; }
            });
            const distToCenter = dist(this.x, this.y, MAP_SIZE/2, MAP_SIZE/2);
            if (gameTime <= gameSettings.time && (zone.radius - distToCenter) < 100) {
                let ang = Math.atan2(MAP_SIZE/2 - this.y, MAP_SIZE/2 - this.x);
                this.velocity.x = Math.cos(ang) * this.speed; this.velocity.y = Math.sin(ang) * this.speed;
                this.angle = ang;
                if(!this.isJumping) { this.vz = 300; this.isJumping = true; }
            } else if (nearest) {
                let ang = Math.atan2(nearest.y - this.y, nearest.x - this.x); this.angle = ang;
                if (this.activeSlot === 1 && this.weapon.currentMag === 0 && this.weapon.reserveAmmo === 0) this.switchSlot(0);
                else if (this.activeSlot === 0 && this.inventory[1] && this.inventory[1].currentMag > 0) this.switchSlot(1);
                
                if (this.reactionTimer <= 0) {
                    this.reactionTimer = 0.5 + Math.random();
                    // STRAFE MOVEMENT: Add lateral component
                    let moveAng = ang;
                    if((this.weapon.type === 'shotgun' || this.weapon.type === 'melee')) {
                         if(minDst > 100) moveAng = ang; // Rush
                    } else {
                        // Strafe
                        moveAng = ang + (Math.PI / 2) * this.strafeDir;
                    }

                    this.velocity.x = Math.cos(moveAng) * this.speed; this.velocity.y = Math.sin(moveAng) * this.speed;
                }
                this.shoot();
            } else {
                if (this.reactionTimer <= 0) {
                    this.reactionTimer = 2; let rAngle = Math.random() * Math.PI * 2;
                    this.velocity.x = Math.cos(rAngle) * (this.speed * 0.5); this.velocity.y = Math.sin(rAngle) * (this.speed * 0.5); this.angle = rAngle;
                }
            }
            if (this.weapon && this.weapon.type !== 'melee' && this.weapon.type !== 'throwable' && this.weapon.currentMag <= 0) this.reload();
        }
        shoot() {
            if (gameState === 'COUNTDOWN' || !this.weapon || this.weapon.isReloading) return;
            
            if (this.weapon.type === 'throwable') {
                if (this.weapon.cooldown <= 0 && this.weapon.count > 0) {
                    this.weapon.cooldown = this.weapon.rate;
                    this.weapon.count--;
                    if (this.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this)) Sound.shoot('grenade');
                    grenadeProjectiles.push(new GrenadeProjectile(this.x, this.y, this.angle, this.weapon.speed, this));
                    if (this.weapon.count <= 0) {
                        if (this.inventory[0]) this.switchSlot(0);
                        else this.switchSlot(1);
                    }
                    if (this.isPlayer) updateHUD();
                }
                return;
            }

            if (this.weapon.type === 'melee') {
                if (this.weapon.cooldown <= 0) {
                    this.weapon.cooldown = this.weapon.rate; this.attackTimer = 0.2; 
                    if (this.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this)) Sound.shoot('knife');
                    let targets = [player, ...bots];
                    let hit = false;
                    for (let t of targets) {
                        if (t === this || t.markedForDeletion) continue;
                        if (dist(this.x, this.y, t.x, t.y) < this.weapon.range + t.radius) {
                            let angleTo = Math.atan2(t.y - this.y, t.x - this.x);
                            let diff = Math.abs(angleTo - this.angle); if (diff > Math.PI) diff -= Math.PI*2;
                            if (Math.abs(diff) < 1.2) { 
                                t.takeDamage(this.weapon.damage, this); hit = true; createParticles(t.x, t.y, '#ef4444', 3);
                            }
                        }
                    }
                    if (hit && (this.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this))) { Sound.hit(); hitMarkerTime = 0.2; }
                }
                return;
            }

            if (this.weapon.currentMag <= 0) { this.reload(); return; }
            if (this.weapon.cooldown <= 0) {
                this.weapon.cooldown = this.weapon.rate;
                this.weapon.currentMag--;
                
                if (this.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this)) { updateHUD(); camera.shake(0.1); Sound.shoot(this.weapon.type); }
                for(let i=0; i<this.weapon.count; i++) {
                    let spr = (Math.random() - 0.5) * this.weapon.spread;
                    let bulletColor = this.weapon.color;
                    bullets.push(new Bullet(this.x, this.y, this.angle + spr, this.weapon.speed * (0.9 + Math.random()*0.2), this.weapon.damage, this, bulletColor));
                }
            }
        }
        takeDamage(amount, source, isZone = false) {
            if (gameState === 'COUNTDOWN') {
                if(!isZone) damageTexts.push(new DamageText(this.x, this.y - 40, "0", false, '#9ca3af'));
                return;
            }
            if (this.shield > 0 && !isZone) {
                let sDmg = Math.min(this.shield, amount); this.shield -= sDmg; amount -= sDmg; createParticles(this.x, this.y, '#3b82f6', 3);
            }
            this.hp -= amount;
            if (!isZone) {
                createParticles(this.x, this.y, '#ef4444', 5);
                damageTexts.push(new DamageText(this.x, this.y - 30, Math.floor(amount + (this.shield>0?amount:0)), this.shield > 0));
                if (this.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this)) {
                    const overlay = document.getElementById('damage-overlay');
                    overlay.style.boxShadow = 'inset 0 0 50px 20px rgba(255,0,0,0.5)';
                    setTimeout(() => overlay.style.boxShadow = 'none', 100);
                    camera.shake(0.3);
                } else if (source && (source.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === source))) { Sound.hit(); hitMarkerTime = 0.2; }
            }
            if (this.hp <= 0 && !this.markedForDeletion) this.die(source);
        }
        die(killer) {
            this.markedForDeletion = true;
            createParticles(this.x, this.y, this.color, 20); spawnLoot(this.x, this.y); Sound.kill();
            bloodSplats.push(new BloodSplat(this.x, this.y, '#7f1d1d')); // Blood splat

            if(Math.random() > 0.5) items.push(new Item(this.x, this.y, 'medkit')); else items.push(new Item(this.x, this.y, 'shield'));
            let kName = killer ? killer.name : "LA ZONA"; addKillFeed(kName, this.name);
            
            if (gameState === 'SPECTATING' && spectatingTarget === this) {
                if (killer && !killer.markedForDeletion && killer !== this) { spectatingTarget = killer; } 
                else { let aliveBots = bots.filter(b => !b.markedForDeletion && b !== this); if (aliveBots.length > 0) spectatingTarget = aliveBots[0]; else endGame(false, "Partida Terminada"); }
                updateHUD();
            }

            if (killer && killer.isPlayer) { 
                killer.kills++; 
                if(killer.kills === 2) showStreakMessage("¬°DOBLE KILL!");
                if(killer.kills === 3) showStreakMessage("¬°TRIPLE KILL!");
                if(killer.kills >= 4) showStreakMessage("¬°IMPARABLE!");
                updateHUD(); 
                showFloatingMessage("KILL!", this.x, this.y, '#fbbf24'); 
            }
            if (this.isPlayer) endGame(false, "ELIMINADO POR " + kName, killer);
        }
    }

    class Bullet extends Entity {
        constructor(x, y, angle, speed, damage, owner, color) {
            super(x, y, 4, color || '#fff'); this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
            this.damage = damage; this.owner = owner; this.distTraveled = 0;
        }
        update(dt) {
            this.x += this.vx * dt; this.y += this.vy * dt; this.distTraveled += Math.hypot(this.vx*dt, this.vy*dt);
            if (this.distTraveled > 1000) this.markedForDeletion = true;
            for (let t of trees) {
                if (dist(this.x, this.y, t.x, t.y) < t.radius + this.radius) {
                    this.markedForDeletion = true; createParticles(this.x, this.y, '#4ade80', 2); 
                    t.hp -= this.damage; t.hitFlash = 0.1;
                    if(t.hp <= 0) { t.markedForDeletion = true; createParticles(t.x, t.y, '#166534', 15); }
                    return;
                }
            }
            for (let r of rocks) if (dist(this.x, this.y, r.x, r.y) < r.radius + this.radius) { this.markedForDeletion = true; createParticles(this.x, this.y, '#9ca3af', 2); return; }
            let targets = [player, ...bots];
            for (let t of targets) {
                if (t === this.owner || t.markedForDeletion) continue;
                if (t.z > 20) continue; 
                if (dist(this.x, this.y, t.x, t.y) < t.radius + this.radius + 5) {
                    t.takeDamage(this.damage, this.owner);
                    if (this.owner && (this.owner.isPlayer || (gameState === 'SPECTATING' && spectatingTarget === this.owner))) this.owner.stats.damageDealt += this.damage;
                    this.markedForDeletion = true; return;
                }
            }
        }
    }

    class DamageText {
        constructor(x, y, text, isShield, colorOverride) {
            this.x = x; this.y = y; this.text = (typeof text === 'number') ? "-" + Math.ceil(text) : text;
            this.color = colorOverride ? colorOverride : (isShield ? '#60a5fa' : '#ffffff');
            this.life = 1.0; this.vy = -50;
        }
        update(dt) { this.y += this.vy * dt; this.life -= dt; }
    }

    class Item extends Entity {
        constructor(x, y, type) { super(x, y, 15, '#fff'); this.type = type; this.floatOffset = Math.random() * Math.PI * 2; this.msgCooldown = 0;
        }
        update(dt) {
            this.floatOffset += dt * 3; if (this.msgCooldown > 0) this.msgCooldown -= dt;
            if (dist(this.x, this.y, player.x, player.y) < player.radius + this.radius && !player.markedForDeletion) {
                
                // DISTINCION ENTRE INTERACCION Y AUTO-PICKUP
                if (['medkit', 'shield', 'ammo', 'grenade'].includes(this.type)) {
                     // AUTO PICKUP
                     let picked = false; let msg = ""; let color = "#fff";
                     
                     if (this.type === 'grenade') { // CHEQUEO PRIMERO
                        player.pickUpGrenade(); 
                        this.markedForDeletion = true;
                        updateHUD();
                        return;
                     }

                     if (this.type === 'medkit') { if (player.hp < 100) { player.hp = Math.min(100, player.hp + 50); msg = "+VIDA"; color = "#22c55e"; picked = true; } }
                     else if (this.type === 'shield') { if (player.shield < 100) { player.shield = Math.min(100, player.shield + 50); msg = "+ESCUDO"; color = "#3b82f6"; picked = true; } }
                     else if (WEAPONS[this.type]) { player.pickUpWeapon(this.type); player.stats.upgrades++; msg = "EQUIPADO: " + WEAPONS[this.type].name; color = WEAPONS[this.type].color; picked = true; }
                     else if (this.type === 'ammo') {
                          if (player.inventory[0]) { 
                             let w = player.inventory[0]; let added = w.magSize * 2;
                             if (w.reserveAmmo < w.maxReserve) { w.reserveAmmo = Math.min(w.reserveAmmo + added, w.maxReserve); msg = "+MUNICION"; color = "#fbbf24"; picked = true; }
                             else if(this.msgCooldown <= 0) { showFloatingMessage("LLENO", player.x, player.y, '#9ca3af'); this.msgCooldown = 1.5; }
                          }
                     }
                     if (picked) { showFloatingMessage(msg, player.x, player.y, color); Sound.playTone(500, 'sine', 0.1, 0.1); this.markedForDeletion = true; updateHUD(); }
                } else {
                    // ARMAS (REQUIEREN G)
                    interactableItem = this; // Marcar como posible de interactuar
                }
            } else {
                if (interactableItem === this) interactableItem = null; // Desmarcar si me alejo
            }
        }
    }

    function dist(x1, y1, x2, y2) { return Math.hypot(x2-x1, y2-y1); }
    function createParticles(x, y, color, count) { for(let i=0; i<count; i++) particles.push({ x: x, y: y, vx: (Math.random()-0.5)*200, vy: (Math.random()-0.5)*200, life: 0.5+Math.random()*0.5, color: color }); }
    function spawnLoot(x, y) {
        const rand = Math.random();
        // Aumentar densidad segun settings
        const density = gameSettings.lootDensity || 1;
        // Logic for probability slightly adjusted for density
        if (rand < 0.2 * density) items.push(new Item(x, y, 'medkit'));
        else if (rand < 0.4 * density) items.push(new Item(x + 20, y, 'shield'));
        else if (rand < 0.6 * density) items.push(new Item(x - 20, y, 'ammo'));
        else if (rand < 0.7 * density) items.push(new Item(x, y + 20, 'grenade'));
        else items.push(new Item(x, y, ['shotgun', 'rifle', 'sniper'][Math.floor(Math.random()*3)]));
    }
    function showFloatingMessage(text, x, y, color) { messages.push({text, x, y, color, life: 1.5, z: 0}); }
    
    function generateWorld() {
        trees = []; bushes = []; rocks = []; bloodSplats = [];
        for(let i=0; i<80; i++) { 
            trees.push({ x: Math.random()*MAP_SIZE, y: Math.random()*MAP_SIZE, radius: 25+Math.random()*25, hp: 50, hitFlash: 0, 
            leaves: Array(5).fill(0).map(() => ({dx: (Math.random()-0.5)*40, dy: (Math.random()-0.5)*40, r: 15+Math.random()*15})) });
        }
        for(let i=0; i<30; i++) bushes.push({ x: Math.random()*MAP_SIZE, y: Math.random()*MAP_SIZE, radius: 40+Math.random()*20 });
        for(let i=0; i<20; i++) rocks.push({ x: Math.random()*MAP_SIZE, y: Math.random()*MAP_SIZE, radius: 30+Math.random()*20 }); 
        items = []; 
        let lootCount = 40 * (gameSettings.lootDensity || 1);
        for(let i=0; i<lootCount; i++) spawnLoot(Math.random()*MAP_SIZE, Math.random()*MAP_SIZE);
    }

    // --- FUNCIONES SALA PRIVADA ---
    function showLobbyScreen(isCreator) {
        document.getElementById('side-panel-right').classList.remove('open');
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'flex';
        
        const code = document.getElementById('room-code').value || generateRoomCode();
        document.getElementById('lobby-code-text').innerText = code;
        document.getElementById('lobby-code-display').innerText = code;
        
        const list = document.getElementById('lobby-player-list');
        list.innerHTML = `<div class="lobby-player-row">üëë ${document.getElementById('username-input').value || 'JUGADOR'} (T√∫)</div>`;
        
        if(isCreator) {
            document.getElementById('creator-controls').style.display = 'block'; document.getElementById('guest-controls').style.display = 'none'; document.getElementById('start-match-btn').style.display = 'inline-block';
        } else {
            document.getElementById('creator-controls').style.display = 'none'; document.getElementById('guest-controls').style.display = 'block'; document.getElementById('start-match-btn').style.display = 'none';
        }
    }
    function generateRoomCode() { return Math.random().toString(36).substring(2,8).toUpperCase(); }
    function joinRoom() { const code = document.getElementById('join-code').value; if(code.length < 3) { alert("C√≥digo inv√°lido"); return; } showLobbyScreen(false); }
    function exitLobby() { document.getElementById('lobby-screen').style.display = 'none'; document.getElementById('start-screen').style.display = 'flex'; }
    function startCustomMatch() {
        const botsCount = parseInt(document.getElementById('lobby-bots').value);
        gameSettings.botCount = botsCount;
        document.getElementById('lobby-screen').style.display = 'none';
        startGame(true); 
    }
    function createCustomGame() { showLobbyScreen(true); }

    function startGame(isCustom = false) {
        const nameInput = document.getElementById('username-input');
        const rawName = nameInput.value.trim();
        if (!rawName) { nameInput.classList.add('input-error'); nameInput.focus(); setTimeout(() => nameInput.classList.remove('input-error'), 300); return; }
        const playerName = rawName.toUpperCase();
        
        // OCULTAR BOTONES DE ESQUINA
        document.querySelectorAll('.corner-btn').forEach(btn => btn.style.display = 'none');

        document.getElementById('side-panel-left').classList.remove('open');
        document.getElementById('side-panel-right').classList.remove('open');
        
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('game-over-screen').style.display = 'none';
        document.getElementById('kill-feed').innerHTML = ''; 
        document.getElementById('spectator-bar').style.display = 'none';
        document.body.classList.remove('spectating-hud');

        gameState = 'COUNTDOWN'; countdownTimer = COUNTDOWN_TIME;
        document.getElementById('countdown-overlay').style.display = 'block';
        
        zone.damage = 10; // Default

        player = new Character(MAP_SIZE/2, MAP_SIZE/2, true, selectedPlayerColor);
        player.name = playerName; camera.x = player.x; camera.y = player.y;
        bots = []; bullets = []; particles = []; messages = []; damageTexts = []; grenadeProjectiles = []; bloodSplats = []; // RESET BLOOD
        interactableItem = null;
        zone.radius = MAP_SIZE * 2; gameTime = gameSettings.time;
        
        generateWorld();
        
        let botCount = isCustom ? gameSettings.botCount : 19; // 19 bots + 1 player = 20 total
        totalPlayersStart = botCount + 1;

        for(let i=0; i<botCount; i++) {
            let angle = (Math.PI*2/botCount)*i; let d = 900+Math.random()*200;
            bots.push(new Character(MAP_SIZE/2+Math.cos(angle)*d, MAP_SIZE/2+Math.sin(angle)*d));
        }
        lastTime = performance.now(); updateHUD(); Sound.ui(); requestAnimationFrame(loop);
    }
    
    function startSpectate() {
        if (lastKiller && !lastKiller.markedForDeletion) { spectatingTarget = lastKiller; } 
        else { let aliveBots = bots.filter(b => !b.markedForDeletion); if (aliveBots.length > 0) spectatingTarget = aliveBots[0]; else return; }
        gameState = 'SPECTATING';
        document.getElementById('game-over-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('spectator-bar').style.display = 'flex';
        document.body.classList.add('spectating-hud');
        updateHUD();
    }

    function restartGame() { 
        document.getElementById('game-over-screen').style.display = 'none'; 
        // Mostrar botones de nuevo
        document.querySelectorAll('.corner-btn').forEach(btn => btn.style.display = 'flex');
        // Ir a inicio en vez de reiniciar directo para ver menu
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('hud').style.display = 'none';
    }

    function loop(timestamp) {
        if (gameState !== 'PLAYING' && gameState !== 'COUNTDOWN' && gameState !== 'SPECTATING' && gameState !== 'GAMEOVER') return;
        const dt = Math.min((timestamp - lastTime) / 1000, 0.1); lastTime = timestamp;
        update(dt); draw(); requestAnimationFrame(loop);
    }

    function update(dt) {
        if (gameState === 'COUNTDOWN') {
            countdownTimer -= dt;
            const overlay = document.getElementById('countdown-overlay');
            if (countdownTimer > 0) { overlay.innerText = Math.ceil(countdownTimer); overlay.style.color = '#fbbf24'; camera.update(player, dt); return; }
            else { gameState = 'PLAYING'; overlay.innerText = "¬°YA!"; overlay.style.color = '#4ade80'; setTimeout(() => { overlay.style.display = 'none'; }, 1000); }
        }
        
        if(gameState !== 'GAMEOVER') {
             gameTime -= dt;
             let progress = 1 - (Math.max(0, gameTime) / gameSettings.time);
             const START_R = MAP_SIZE * 2; const END_R = 100;
             zone.radius = START_R - ((START_R - END_R) * progress);
             document.getElementById('timer').innerText = Math.max(0, Math.floor(gameTime)) + "s";
        }

        if(hitMarkerTime > 0) hitMarkerTime -= dt;

        if (gameState === 'PLAYING') {
            player.velocity.x = 0; player.velocity.y = 0;
            if (keys['KeyW']) player.velocity.y = -player.speed; if (keys['KeyS']) player.velocity.y = player.speed;
            if (keys['KeyA']) player.velocity.x = -player.speed; if (keys['KeyD']) player.velocity.x = player.speed;
            if (player.velocity.x !== 0 && player.velocity.y !== 0) { player.velocity.x *= 0.707; player.velocity.y *= 0.707; }
            if (keys['ShiftLeft'] && player.stamina > 0 && (player.velocity.x !== 0 || player.velocity.y !== 0)) {
                player.velocity.x *= 1.5; player.velocity.y *= 1.5; player.stamina -= 20 * dt;
            } else { player.stamina = Math.min(player.stamina + 10 * dt, player.maxStamina); }
            if (keys['Space'] && !player.isJumping) { player.vz = 350; player.isJumping = true; }
            const screenCX = width / 2; const screenCY = height / 2;
            player.angle = Math.atan2(mouse.y - screenCY, mouse.x - screenCX);
            if (mouse.down) player.shoot();
            player.update(dt);
        }

        bots.forEach(b => b.update(dt)); bullets.forEach(b => b.update(dt));
        items.forEach(i => i.update(dt)); damageTexts.forEach(t => t.update(dt));
        grenadeProjectiles.forEach(g => g.update(dt));
        bots = bots.filter(b => !b.markedForDeletion); bullets = bullets.filter(b => !b.markedForDeletion);
        items = items.filter(i => !i.markedForDeletion); trees = trees.filter(t => !t.markedForDeletion);
        grenadeProjectiles = grenadeProjectiles.filter(g => !g.markedForDeletion);
        trees.forEach(t => { if(t.hitFlash > 0) t.hitFlash -= dt; });
        damageTexts = damageTexts.filter(t => t.life > 0); messages = messages.filter(m => m.life > 0);
        messages.forEach(m => { m.y -= 20*dt; m.life -= dt; });
        
        [player, ...bots].forEach(char => {
            if(char.markedForDeletion) return;
            trees.forEach(tree => {
                let dx = char.x - tree.x; let dy = char.y - tree.y;
                let dist = Math.hypot(dx, dy); let minDist = char.radius + tree.radius;
                if (dist < minDist) {
                    let angle = Math.atan2(dy, dx); let push = minDist - dist;
                    char.x += Math.cos(angle) * push; char.y += Math.sin(angle) * push;
                }
            });
        });
        
        // WIN CONDITION (PLAYER)
        if (gameState === 'PLAYING' && bots.length === 0 && !player.markedForDeletion) endGame(true, "¬°VICTORIA MAGISTRAL!");

        // WIN CONDITION (SPECTATOR) - If spectating target is last one alive
        if (gameState === 'SPECTATING' && spectatingTarget) {
             let survivors = bots.filter(b => !b.markedForDeletion);
             let allAlive = [...survivors];
             if(player && !player.markedForDeletion) allAlive.push(player);

             if(allAlive.length === 1 && allAlive[0] === spectatingTarget) {
                  endGame(false, "GANADOR: " + spectatingTarget.name);
             }
        }
        
        // Camera follow
        if (gameState === 'SPECTATING' && spectatingTarget) {
            camera.update(spectatingTarget, dt);
        } else if (gameState === 'GAMEOVER' && lastKiller && !lastKiller.markedForDeletion) {
            camera.update(lastKiller, dt); 
        } else if (player) {
            camera.update(player, dt);
        }
        
        particles.forEach(p => { p.x += p.vx*dt; p.y += p.vy*dt; p.life -= dt; });
        particles = particles.filter(p => p.life > 0);
        if (gameState === 'SPECTATING' && spectatingTarget) updateHUD(); 
        else if (gameState === 'PLAYING') updateHUD();
    }

    function draw() {
        ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, width, height);
        ctx.save();
        ctx.translate(width/2 - camera.x + camera.shakeX, height/2 - camera.y + camera.shakeY);

        // DRAW GRID
        ctx.fillStyle = '#1f2937'; ctx.fillRect(0, 0, MAP_SIZE, MAP_SIZE); // Background
        ctx.strokeStyle = '#374151'; ctx.lineWidth = 2; ctx.beginPath();
        for(let x=0; x<=MAP_SIZE; x+=TILE_SIZE) { ctx.moveTo(x,0); ctx.lineTo(x,MAP_SIZE); }
        for(let y=0; y<=MAP_SIZE; y+=TILE_SIZE) { ctx.moveTo(0,y); ctx.lineTo(MAP_SIZE,y); }
        ctx.stroke();

        bloodSplats.forEach(b => {
             ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
        });

        items.forEach(item => {
            ctx.save(); ctx.translate(item.x, item.y + Math.sin(item.floatOffset)*5); 
            const pulse = (Math.sin(Date.now() / 200) + 1) / 2; ctx.shadowBlur = 20 + pulse * 10; 
            if (item.type === 'medkit') {
                ctx.shadowColor = '#22c55e'; ctx.fillStyle = '#22c55e'; ctx.fillRect(-10, -10, 20, 20);
                ctx.shadowBlur = 0; ctx.fillStyle = 'white'; ctx.fillRect(-3, -8, 6, 16); ctx.fillRect(-8, -3, 16, 6);
            } else if (item.type === 'shield') {
                ctx.shadowColor = '#3b82f6'; ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0; ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(-3,-3,5,0,Math.PI*2); ctx.fill();
            } else if (item.type === 'ammo') {
                ctx.shadowColor = '#fbbf24'; ctx.fillStyle = '#fbbf24'; ctx.fillRect(-8, -8, 16, 16);
                ctx.shadowBlur = 0; ctx.fillStyle = '#b45309'; ctx.fillRect(-8, -2, 16, 4);
            } else if (item.type === 'grenade') {
                ctx.shadowColor = '#10b981'; ctx.fillStyle = '#10b981'; ctx.fillRect(-8, -8, 16, 16);
                ctx.shadowBlur = 0; ctx.fillStyle = '#065f46'; ctx.fillRect(-4, -4, 8, 8); 
            } else {
                const w = WEAPONS[item.type]; 
                if(w) {
                    ctx.shadowColor = w.color; ctx.fillStyle = w.color; ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(12,6); ctx.lineTo(-12,6); ctx.fill();
                }
            }
            
            // DIBUJAR PROMPT DE INTERACCION ("G")
            if (interactableItem === item && gameState === 'PLAYING') {
                 ctx.fillStyle = 'white'; ctx.font = "bold 14px Roboto";
                 ctx.fillText("E RECOGER", 0, -20);
            }
            
            ctx.restore();
        });

        rocks.forEach(r => {
            ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.fillStyle = '#4b5563'; ctx.beginPath(); ctx.arc(r.x, r.y, r.radius, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0; ctx.strokeStyle = '#374151'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#6b7280'; ctx.beginPath(); ctx.arc(r.x - 5, r.y - 5, r.radius/3, 0, Math.PI*2); ctx.fill();
        });
        
        grenadeProjectiles.forEach(g => {
            ctx.fillStyle = '#10b981'; ctx.beginPath(); ctx.arc(g.x, g.y, g.radius, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#064e3b'; ctx.lineWidth = 2; ctx.stroke();
        });

        [...bots, player].forEach(p => {
            if(p.markedForDeletion) return;
            let inBush = false; for(let b of bushes) if(dist(p.x, p.y, b.x, b.y) < b.radius) inBush = true;
            ctx.globalAlpha = (inBush && p !== player) ? 0.1 : 1.0; if(inBush && p === player) ctx.globalAlpha = 0.6;
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath();
            let shadowScale = Math.max(0.5, 1 - p.z/200);
            ctx.ellipse(p.x, p.y, p.radius*shadowScale, p.radius*0.6*shadowScale, 0, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;
        });

        let renderList = [...bots, player, ...trees, ...bushes, ...bullets].sort((a,b) => a.y - b.y);
        renderList.forEach(e => {
            if (e instanceof Bullet) {
                ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, 4, 0, Math.PI*2); ctx.fill();
            } else if (e.radius && e.color && e.hp !== undefined) { 
                if (e.markedForDeletion) return;
                let inBush = false; for(let b of bushes) if(dist(e.x, e.y, b.x, b.y) < b.radius) inBush = true;
                ctx.globalAlpha = (inBush && e !== player) ? 0.1 : 1.0; if(inBush && e === player) ctx.globalAlpha = 0.6;
                let visualY = e.y - (e.z || 0);
                ctx.save(); ctx.translate(e.x, visualY); ctx.rotate(e.angle);
                
                // SAFETY CHECK: Verificar si tiene arma antes de dibujar
                if (e.weapon) {
                    if (e.weapon.type !== 'melee' && e.weapon.type !== 'throwable') {
                        ctx.fillStyle = e.weapon.color;
                        if(e.weapon.type === 'shotgun') ctx.fillRect(10, -8, 20, 16);
                        else if(e.weapon.type === 'sniper') ctx.fillRect(10, -3, 40, 6); 
                        else ctx.fillRect(10, -5, 25, 10); 
                    } else if(e.weapon.type === 'melee') {
                        let swingX = 15; let swingY = 10; let swingRot = 0;
                        if (e.attackTimer > 0) {
                            const t = 1 - (e.attackTimer / 0.2); 
                            const reach = Math.sin(t * Math.PI) * 15;
                            const swipe = Math.cos(t * Math.PI) * 20; 
                            swingX += reach; swingY -= swipe; swingRot = -Math.cos(t * Math.PI) * 1.5; 
                            ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
                            ctx.beginPath(); ctx.moveTo(15, 10); ctx.quadraticCurveTo(swingX+10, swingY, swingX+20, swingY-10); ctx.stroke();
                        }
                        ctx.save();
                        ctx.translate(swingX, swingY); ctx.rotate(swingRot);
                        ctx.fillStyle = '#d1d5db'; ctx.beginPath(); ctx.moveTo(0, -3); ctx.lineTo(25, 0); ctx.lineTo(0, 3); ctx.fill();
                        ctx.fillStyle = '#374151'; ctx.fillRect(-8, -4, 8, 8);
                        ctx.restore();
                    } else if(e.weapon.type === 'throwable') {
                         ctx.fillStyle = '#10b981'; ctx.beginPath(); ctx.arc(15, 5, 6, 0, Math.PI*2); ctx.fill();
                    }
                    
                    if (e.weapon.type !== 'melee' && e.weapon.type !== 'throwable') {
                         ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(20, 10, 8, 0, Math.PI*2); ctx.arc(20, -10, 8, 0, Math.PI*2); ctx.fill();
                    } else {
                         ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.arc(20, -10, 8, 0, Math.PI*2); ctx.fill(); 
                         ctx.beginPath(); ctx.arc(10, 10, 8, 0, Math.PI*2); ctx.fill(); 
                    }
                }

                ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(0, 0, e.radius, 0, Math.PI*2); ctx.fill();
                if (e.shield > 0) { ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 3; ctx.stroke(); }
                ctx.restore();
                if (!e.isPlayer) { ctx.fillStyle = 'black'; ctx.fillRect(e.x - 20, visualY - 40, 40, 6); ctx.fillStyle = '#ef4444'; ctx.fillRect(e.x - 20, visualY - 40, 40 * (e.hp/e.maxHp), 6); }
                ctx.globalAlpha = 1.0;
            } else if (e.radius && e.hp !== undefined) { 
                ctx.fillStyle = e.hitFlash > 0 ? '#ffffff' : '#166534'; ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = e.hitFlash > 0 ? '#ffffff' : '#22c55e'; ctx.beginPath(); ctx.arc(e.x, e.y - 10, e.radius * 0.8, 0, Math.PI*2); ctx.fill();
            } else if (e.radius) { 
                if(bushes.includes(e)) {
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.4)'; ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = 'rgba(22, 101, 52, 0.5)'; ctx.lineWidth = 2; ctx.stroke();
                }
            }
        });

        particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; });
        ctx.font = "bold 16px Roboto"; ctx.textAlign = "center";
        messages.forEach(m => { ctx.fillStyle = m.color; ctx.fillText(m.text, m.x, m.y); });
        ctx.font = "bold 20px 'Black Ops One'"; 
        damageTexts.forEach(t => { ctx.fillStyle = 'black'; ctx.fillText(t.text, t.x + 2, t.y + 2); ctx.fillStyle = t.color; ctx.fillText(t.text, t.x, t.y); });

        ctx.restore();
        drawMinimap();
        if (hitMarkerTime > 0 && gameState === 'PLAYING') {
            ctx.save(); ctx.strokeStyle = `rgba(255, 255, 255, ${hitMarkerTime * 5})`; ctx.lineWidth = 3;
            const mx = mouse.x; const my = mouse.y; const size = 10;
            ctx.beginPath(); ctx.moveTo(mx - size, my - size); ctx.lineTo(mx + size, my + size); ctx.moveTo(mx + size, my - size); ctx.lineTo(mx - size, my + size); ctx.stroke();
            ctx.restore();
        }

        ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.beginPath(); ctx.rect(-MAP_SIZE*2, -MAP_SIZE*2, MAP_SIZE*5, MAP_SIZE*5);
        let safeX = (MAP_SIZE/2 - camera.x + camera.shakeX) + width/2;
        let safeY = (MAP_SIZE/2 - camera.y + camera.shakeY) + height/2;
        ctx.arc(safeX, safeY, zone.radius, 0, Math.PI*2, true);
        ctx.closePath(); ctx.fillStyle = COLORS.zone; ctx.fill('evenodd');
        ctx.beginPath(); ctx.arc(safeX, safeY, zone.radius, 0, Math.PI*2);
        ctx.strokeStyle = COLORS.zoneLine; ctx.lineWidth = 5; ctx.stroke();
        ctx.restore();

        drawMinimap();
    }

    function drawMinimap() {
        const size = 150; const margin = 20;
        ctx.save();    
        const uiMmX = width - size - margin; const uiMmY = margin;
        ctx.beginPath(); ctx.rect(uiMmX, uiMmY, size, size); ctx.clip(); 
        ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(uiMmX, uiMmY, size, size);
        const scale = size / MAP_SIZE;
        let target = (gameState === 'SPECTATING' && spectatingTarget) ? spectatingTarget : player;
        if (target && !target.markedForDeletion) {
            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(uiMmX + target.x * scale, uiMmY + target.y * scale, 3, 0, Math.PI*2); ctx.fill();
        }
        ctx.strokeStyle = 'rgba(255,0,0,0.8)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(uiMmX + MAP_SIZE/2 * scale, uiMmY + MAP_SIZE/2 * scale, zone.radius * scale, 0, Math.PI*2); ctx.stroke();
        ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2; ctx.strokeRect(uiMmX, uiMmY, size, size);
        ctx.restore(); 
    }

    function updateHUD() {
        let target = (gameState === 'SPECTATING' && spectatingTarget) ? spectatingTarget : player;
        if (!target) return;

        if (gameState === 'SPECTATING') {
             document.getElementById('spectator-info').innerText = "ESPECTANDO A: " + target.name;
        }

        document.getElementById('hp-val').innerText = Math.ceil(target.hp);
        document.getElementById('hp-fill').style.width = (target.hp / target.maxHp * 100) + '%';
        document.getElementById('shield-val').innerText = Math.ceil(target.shield);
        document.getElementById('shield-fill').style.width = (target.shield / target.maxShield * 100) + '%';
        // Stamina bar
        document.getElementById('stamina-fill').style.width = (target.stamina / target.maxStamina * 100) + '%';

        document.getElementById('kill-count').innerText = target.kills;
        
        let liveCount = bots.filter(b => !b.markedForDeletion).length + (player.markedForDeletion ? 0 : 1);
        document.getElementById('alive-count').innerText = liveCount;
        
        // CALCULO CORRECTO DE VIVOS
        if(totalPlayersStart > 0) {
             document.getElementById('total-count').innerText = totalPlayersStart;
        }

        // SAFETY CHECK: Update weapon only if valid
        if (target.weapon) {
            document.getElementById('weapon-name').innerText = target.weapon.name;
            document.getElementById('weapon-name').style.color = target.weapon.color;
            
            const ammoDisplay = document.getElementById('ammo-display');
            const currentMag = document.getElementById('current-mag');
            const reserveAmmo = document.getElementById('reserve-ammo');

            if(target.weapon.type === 'melee') {
                currentMag.innerText = "‚àû"; reserveAmmo.innerText = "";
                ammoDisplay.classList.remove('no-ammo');
            } else if (target.weapon.type === 'throwable') {
                currentMag.innerText = target.weapon.count; reserveAmmo.innerText = "";
                ammoDisplay.classList.remove('no-ammo');
            } else {
                if (target.weapon.isReloading) { currentMag.innerText = "REC"; currentMag.classList.add('reloading'); }
                else { currentMag.innerText = target.weapon.currentMag; currentMag.classList.remove('reloading'); }
                reserveAmmo.innerText = "/ " + target.weapon.reserveAmmo;
                if (target.weapon.currentMag === 0 && target.weapon.reserveAmmo === 0) ammoDisplay.classList.add('no-ammo'); else ammoDisplay.classList.remove('no-ammo');
            }
        }
        
        document.getElementById('slot-1').classList.toggle('active', target.activeSlot === 0);
        document.getElementById('slot-2').classList.toggle('active', target.activeSlot === 1);
        document.getElementById('slot-3').classList.toggle('active', target.activeSlot === 2);
    }

    function endGame(win, reason, killer) {
        gameState = 'GAMEOVER';
        lastKiller = killer; 
        document.getElementById('hud').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'flex';
        document.getElementById('countdown-overlay').style.display = 'none';
        
        document.getElementById('spectator-bar').style.display = 'none';
        document.body.classList.remove('spectating-hud');
        
        // MOSTRAR BOTONES DE NUEVO
        document.querySelectorAll('.corner-btn').forEach(btn => btn.style.display = 'none'); // En Game Over no queremos login

        const title = document.getElementById('end-title');
        title.innerText = win ? "¬°VICTORIA!" : "HAS MUERTO";
        title.style.color = win ? "#4ade80" : "#ef4444";
        const rank = win ? 1 : bots.length + 1;
        document.getElementById('final-rank').innerText = "#" + rank;
        document.getElementById('end-reason').innerText = reason;
        
        // CORRECCION TIEMPO
        // Si gameSettings.time no est√° definido, usar default
        let maxTime = gameSettings ? gameSettings.time : 120;
        const timeSurvived = Math.floor(maxTime - Math.max(0, gameTime));

        document.getElementById('stat-kills').innerText = player.kills;
        document.getElementById('stat-time').innerText = timeSurvived + "s";
        document.getElementById('stat-damage').innerText = Math.floor(player.stats.damageDealt);
        document.getElementById('stat-upgrades').innerText = player.stats.upgrades;
        
        let canSpectate = !win && (killer || bots.some(b => !b.markedForDeletion));
        document.getElementById('btn-spectate').style.display = canSpectate ? 'inline-block' : 'none';
    }
</script>
</body>
</html>